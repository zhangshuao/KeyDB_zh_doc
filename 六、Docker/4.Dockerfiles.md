# KeyDB官方 Dockerfiles

此页包含用于生成不同镜像的dockerfile和用于镜像的标记。他们在这里列出的透明度，所以你可以看到你得到什么。
它还允许您自定义一个可以更好地满足您需要的自定义镜像。

如果您发现一些您认为有益的重大改进，我们将随时提供反馈。这些镜像都是从官方发布分支构建的。标签将在最后进行版本控制，即v0.9.5。
启动服务器时，您还将看到版本号。东部时间每天早上4点有一个镜像,随着项目的发展,对于不稳定的分支. 给那些保持喜欢的人

## Mainfest

拉 eqalpha/keydb 是一个 主docker镜像 "lastest" 清单, 这意味着有3个相关的镜像, x86_64_vxxx，arm_vxxx， arm64_vxxx
根据您的系统，清单文件将提取适当的镜像. 这主要是基于github上最新的官方发布分支.

## 构建镜像

您将从Dockerfile中注意到，您应该在Dockerfile所在的位置有一个"app"目录。
Dockerfile应该命名为"Dockerfile"。在"app"文件夹中，您应该放置要复制的二进制文件（至少keydb服务器）。
redis.conf文件也应该位于这里。你可以根据自己的喜好定制，这是有益的。Dockerfile修改Dockerfile中的基本配置文件，而不是使用自定义Dockerfile。
所以您可以考虑删除脚本中修改它的部分。

查看Dockerfiles，了解我们在下面生成的5个主要 images/tags 以及构建器：

## 标准构建

    #
    # KeyDB Dockerfile for x86_64
    #
    #
    # Pull base image.
    FROM ubuntu:18.04
    
    # add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
    RUN groupadd -r keydb && useradd -r -g keydb keydb
    
    # grab gosu for easy step-down from root
    # https://github.com/tianon/gosu/releases
    ENV GOSU_VERSION 1.10
    RUN set -ex; \
        \
        fetchDeps=" \
            ca-certificates \
            dirmngr \
            gnupg \
            wget \
        "; \
        apt-get update; \
        apt-get install -y --no-install-recommends libcurl4-openssl-dev $fetchDeps; \
        rm -rf /var/lib/apt/lists/*; \
        \
        dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
        wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \
        wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \
        export GNUPGHOME="$(mktemp -d)"; \
        gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \
        gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \
        gpgconf --kill all; \
        rm -r "$GNUPGHOME" /usr/local/bin/gosu.asc; \
        chmod +x /usr/local/bin/gosu; \
        gosu nobody true; \
        \
        apt-get purge -y --auto-remove $fetchDeps
    
    
    # Load binaries to image. Much smaller size than building.
    ADD ./app/* /usr/local/bin/
    
    RUN \
      cd /usr/local/bin && \
      mkdir -p /etc/keydb && \
      mv -f *.conf /etc/keydb && \
    # update config file for use in container
      sed -i 's/^\(bind .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(daemonize .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(dir .*\)$/# \1\ndir \/data/' /etc/keydb/redis.conf && \
      sed -i 's/^\(logfile .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/protected-mode yes/protected-mode no/g' /etc/keydb/redis.conf
    
    # Define default command.
    #CMD ["keydb-server", "/etc/keydb/redis.conf"]
    
    RUN mkdir /data && chown keydb:keydb /data
    VOLUME /data
    WORKDIR /data
    
    #COPY docker-entrypoint.sh /usr/local/bin/
    ENTRYPOINT ["docker-entrypoint.sh"]
    
    EXPOSE 6379
    CMD ["keydb-server", "/etc/keydb/redis.conf"]

## ARM构建

    #
    # KeyDB Dockerfile for ARM
    #
    #
    FROM jsurf/rpi-raspbian:latest
    
    RUN [ "cross-build-start" ]
    
    # add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
    RUN groupadd -r keydb && useradd -r -g keydb keydb
    
    # add gosu for easy step-down from root
    ENV GOSU_VERSION 1.10
    RUN set -x \
        && apt-get update && apt-get install -y --no-install-recommends ca-certificates wget libcurl4-openssl-dev && rm -rf /var/lib/apt/lists/* \
        && wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture)" \
        && wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture).asc" \
        && export GNUPGHOME="$(mktemp -d)" \
        && gpg --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \
        && gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \
        && rm -rf "$GNUPGHOME" /usr/local/bin/gosu.asc \
        && chmod +x /usr/local/bin/gosu \
        && gosu nobody true \
        && apt-get purge -y --auto-remove ca-certificates wget
    
    # Load binaries to image. Much smaller size than building.
    ADD ./app/* /usr/local/bin/
    
    RUN \
      cd /usr/local/bin && \
      mkdir -p /etc/keydb && \
      mv -f *.conf /etc/keydb && \
    # update config file for use in container
      sed -i 's/^\(bind .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(daemonize .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(dir .*\)$/# \1\ndir \/data/' /etc/keydb/redis.conf && \
      sed -i 's/^\(logfile .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/protected-mode yes/protected-mode no/g' /etc/keydb/redis.conf
    
    # Define default command.
    #CMD ["keydb-server", "/etc/keydb/redis.conf"]
    
    RUN mkdir /data && chown keydb:keydb /data
    VOLUME /data
    WORKDIR /data
    
    #COPY docker-entrypoint.sh /usr/local/bin/
    ENTRYPOINT ["docker-entrypoint.sh"]
    
    EXPOSE 6379
    CMD ["keydb-server", "/etc/keydb/redis.conf"]
    
    RUN [ "cross-build-end" ]

## 闪存构建

    #
    # KeyDB Dockerfile for x86_64
    #
    # Useage: docker run -it --name mykeydb --mount type=bind,target=/tmp/keydbflash,source=/path-to-my-btrfs-volume/ eqalpha/keydb:flash
    #
    # Pull base image.
    FROM ubuntu:18.04
    
    # add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
    RUN groupadd -r keydb && useradd -r -g keydb keydb
    
    # grab gosu for easy step-down from root
    # https://github.com/tianon/gosu/releases
    ENV GOSU_VERSION 1.10
    RUN set -ex; \
            \
            fetchDeps=" \
                    ca-certificates \
                    dirmngr \
                    gnupg \
                    wget \
            "; \
            apt-get update; \
            apt-get install -y --no-install-recommends $fetchDeps; \
            rm -rf /var/lib/apt/lists/*; \
            \
            dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
            wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \
            wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \
            export GNUPGHOME="$(mktemp -d)"; \
            gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \
            gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \
            gpgconf --kill all; \
            rm -r "$GNUPGHOME" /usr/local/bin/gosu.asc; \
            chmod +x /usr/local/bin/gosu; \
            gosu nobody true; \
            \
            apt-get purge -y --auto-remove $fetchDeps
    
    # Load binaries to image. Much smaller size than building.
    ADD ./app/* /usr/local/bin/
    
    RUN \
      apt-get install -y libnuma-dev libtool libcurl4-openssl-dev && \
      cd /usr/local/bin && \
      mkdir -p /etc/keydb && \
      mkdir /tmp/keydbflash && \
      mv -f *.conf /etc/keydb && \
    # update config file for use in container
      sed -i 's/^\(bind .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(daemonize .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(dir .*\)$/# \1\ndir \/data/' /etc/keydb/redis.conf && \
      sed -i 's/^\(logfile .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/protected-mode yes/protected-mode no/g' /etc/keydb/redis.conf && \
      sed -i '/scratch-file-path/a \scratch-file-path /tmp/keydbflash' /etc/keydb/redis.conf
    
    RUN mkdir /data && chown keydb:keydb /data
    VOLUME /data
    WORKDIR /data
    
    #COPY docker-entrypoint.sh /usr/local/bin/
    ENTRYPOINT ["docker-entrypoint.sh"]
    
    EXPOSE 6379
    CMD ["keydb-server", "/etc/keydb/redis.conf"]

## 不稳定构建

    这与标准构建相同，只是二进制文件是从github上不稳定的分支生成的。

## Docker 构建 - 标准

    # KeyDB Fresh Build
    # 
    # This Docker image will be used to generate the latest binaries from github
    #
    # Useage: docker run -it --rm -v /path-to-dump-binaries:/keydb_bin eqalpha/keydb-build-bin
    #
    # pull the base image
    FROM ubuntu:18.04
    # setup up container with dependencies for build
    RUN apt-get update -y && \
     DEBIAN_FRONTEND=noninteractive apt-get install -qqy \
     build-essential apt-utils nasm autotools-dev autoconf libjemalloc-dev tcl tcl-dev uuid-dev git -y && \
     apt-get clean && \
     mkdir /keydb_bin
    # upon launch we will build project and dump binaries into specified folder on host
    CMD ["sh","-c", "cd /tmp && git clone https://github.com/JohnSully/KeyDB.git && \
     cd KeyDB  && \
     make && \
     cp ./src/keydb-* /keydb_bin"]
     
## Docker 构建 - Flash闪存

    #
    # KeyDB Dockerfile for x86_64
    #
    # Useage: docker run -it --name mykeydb --mount type=bind,target=/tmp/keydbflash,source=/path-to-my-btrfs-volume/ eqalpha/keydb:flash
    #
    # Pull base image.
    FROM ubuntu:18.04
    
    # Load binaries to image. Much smaller size than building.
    ADD ./app/* /usr/local/bin/
    
    RUN \
      apt-get update && \
      apt-get install -y libnuma-dev libtool && \
      cd /usr/local/bin && \
      mkdir -p /etc/keydb && \
      mkdir /tmp/keydbflash && \
      mv -f *.conf /etc/keydb && \
    # update config file for use in container
      sed -i 's/^\(bind .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(daemonize .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/^\(dir .*\)$/# \1\ndir \/data/' /etc/keydb/redis.conf && \
      sed -i 's/^\(logfile .*\)$/# \1/' /etc/keydb/redis.conf && \
      sed -i 's/protected-mode yes/protected-mode no/g' /etc/keydb/redis.conf && \
      sed -i '/scratch-file-path/a \scratch-file-path /tmp/keydbflash' /etc/keydb/redis.conf
    
    # Define mountable directories.
    VOLUME ["/data"]
    
    # Define working directory.
    WORKDIR /data
    
    # Define default command.
    CMD ["keydb-server", "/etc/keydb/redis.conf"]
    
    # Expose ports.
    EXPOSE 6379

## docker-entrypoint.sh

    #!/bin/sh
    set -e
    
    # first arg is `-f` or `--some-option`
    # or first arg is `something.conf`
    if [ "${1#-}" != "$1" ] || [ "${1%.conf}" != "$1" ]; then
        set -- keydb-server "$@"
    fi
    
    # allow the container to be started with `--user`
    if [ "$1" = 'keydb-server' -a "$(id -u)" = '0' ]; then
        find . \! -user keydb -exec chown keydb '{}' +
        exec gosu keydb "$0" "$@"
    fi
    
    exec "$@"
