# 设置Docker容器以在Flash上运行

### 利用支持闪存KeyDB的NVMe SSD

## 要使用的Docker容器

首先确保您正在提取正确的镜像"eqalpha/keydb:flash"。这是用make MALLOC=memkind构建的，并不是我们的"最新"镜像（传统的make），因此请确保在拖动时使用标记"flash"。
此镜像的二进制文件是在最新版本上生成的，当前用于x86-64（amd64）。

## 设置flash闪存

有关此主题的背景信息，请参阅我们的wiki。

你必须在你的SSD上建立btrfs文件系统。我们将挂载一个专门用于此目的的文件夹，请参阅下面的脚本作为示例。
您应该配置systemd unit files 或 fstab，以确保在引导时仍然如此。

    # In this case we have a SSD volume nvme0n1. You will see your volume with command "lsblk"
    # We are mounting to a directory we made /mnt/cache. You can see this mounted with "lsblk" and "df"
    
    ##### set up raid0 #####
    set -e
    mdadm --zero-superblock /dev/nvme0n1
    mdadm --create /dev/md0 --level=0 --raid-devices=1 --force /dev/nvme0n1
    mkfs.btrfs -f /dev/md0
    mount /dev/md0 /mnt/cache -o ssd,nobarrier

## 运行容器

一旦你的卷设置和安装，你可以运行你的docker图像与flash支持启用。必须在run命令中指定将我们在内部为scratch文件路径（/tmp/keydbflash）指定的目录绑定到主机上的装载位置。
如果需要，可以通过在redis.conf中指定Limit来限制大小

    docker run -it --name mykeydb --mount type=bind,target=/tmp/keydbflash,source=/path-to-btrfs-ssd-mount-location-you-made/ eqalpha/keydb:flash

您将看到使用"df"、"df-h"、"lsof"来使用挂载的目录。

## 测试

如果您试图进行测试，可以通过cat和keydb-cli --pipe输入大量命令。例如，通过python循环生成一个txt文件，
创建一百万行"SET key0 val0"，整数为i。

    import sys
    f = open('data.text', 'w')
    for i in range (0,1000000):
        f.write('SET key' + str(i) + ' val' + str(i) + '\n')
    f.close()

现在获取容器的ip docker inspect --format '{{ .NetworkSettings.IPAddress }}' <contianer name> 和 运行cat

    cat data1.txt | keydb-cli --pipe -h <ipaddress-of-container> -p 6379

您应该能够重新启动计算机，并且您设置的装载位置应该仍然存在。检查"lsblk"，"df"在它应该还在的地方。服务器停止时，值将备份到dump.rdb。
它存储在dockerfile中创建的VOLUME卷上，由docker存储在它们的/var/lib/docker/volumes/中

