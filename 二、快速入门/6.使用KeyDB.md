# KeyDB简介

KeyDB是一个开源的内存**数据结构存储**，用作数据库、缓存和消息代理。它支持数据结构，如字符串、哈希、列表、集合、带范围查询的排序集合、位图、超日志、带半径查询的地理空间索引和流。
KeyDB具有内置的复制、Lua脚本、LRU逐出、事务和不同级别的磁盘持久性，并通过 活动复制 或 Sentinel 和 KeyDB集群的自动分区提供高可用性。

您可以对这些类型运行**原子操作**，例如附加到字符串；递增哈希中的值；将元素推送到列表；计算集合的交集、并集和差集；或获取排序集合中排名最高的成员。

为了获得优异的性能，KeyDB使用内存中的数据集。根据您的用例，您可以通过每隔一段时间将数据集转储到磁盘，或者将每个命令追加到日志来持久化它。
如果您只需要一个功能丰富、联网的内存缓存，则可以选择禁用持久性。

KeyDB还支持简单的主从异步复制设置，具有非常快速的非阻塞第一次同步、自动重新连接以及在网络拆分时的部分重新同步。

其他特性包含:

* 事务
* Pub/Sub 发布订阅
* Lua脚本
* 生命周期的key
* LRU回收key
* 自动故障转移

你可以从大多数编程语言中使用KeyDB。

KeyDB是用**ANSI C**编写的，在大多数POSIX系统（如Linux，*BSD，OS X）中工作，没有外部依赖关系。
Linux和OS X是KeyDB开发和测试的两个操作系统，我们**建议使用Linux进行部署**。
KeyDB可以在类似于SmartOS的Solaris派生系统中工作，但支持是最大的努力。
虽然官方不支持Windows版本，但微软开发并维护了KeyDB的Win-64端口

## KeyDB管理

此页包含与KeyDB实例管理相关的主题。每个主题都是以常见问题的形式独立包含的。未来会有新的话题。

### KeyDB设置提示

    * 我们建议使用**Linux操作系统**部署KeyDB。KeyDB也在OS X上进行了大量测试，并不时在FreeBSD和OpenBSD系统上进行测试。然而，Linux是我们进行所有主要压力测试的地方，也是大多数生产部署运行的地方。
    * 请确保将Linux kernel overcommit memory设置设置为1。将vm.overcommit_memory=1添加到/etc/sysctl.conf，然后重新启动或运行命令sysctl vm.overcommit_memory=1，使其立即生效。
    * 请确保禁用Linux内核的透明大页面功能，这将对内存使用和延迟产生负面影响。这是通过以下命令完成的：echo never > /sys/kernel/mm/transparent_hugepage/enabled。
    * 确保在您的系统中设置一些swap交换分区（我们建议交换和内存一样多）。如果Linux没有swap，并且KeyDB实例意外地消耗了太多内存，KeyDB将因内存不足而崩溃，或者Linux内核OOM杀手将杀死KeyDB进程。
    * 当swap交换分区被启用时，KeyDB将以一种不好的方式工作，但是您可能会注意到延迟峰值，并在太迟之前做一些事情。
    * 在实例中设置显式的maxmemory选项限制，以确保在接近系统内存限制时，实例将报告错误而不是失败。注意，应该设置maxmemory来计算KeyDB的开销（数据除外）和碎片开销。因此，如果您认为您有10GB的空闲内存，请将其设置为8或9。
    * 如果您在一个写得很重的应用程序中使用KeyDB，那么在磁盘上保存RDB文件或重写AOF日志KeyDB时，可能会使用通常使用的内存的2倍。使用的额外内存与保存过程中由写入操作修改的内存页数成比例，因此它通常与在此期间触摸的键（或聚合类型项）数成比例。
      一定要相应地调整内存大小。
    * 在daemontools下运行时使用daemonize no。
    * 请确保设置一些非琐碎的复制backlog，这些backlog必须与KeyDB使用的内存量成比例地设置。
      在20GB的实例中，仅仅有1MB的backlog是没有意义的。backlog将允许副本很容易地与主实例重新同步。
    * 即使禁用了持久性，如果使用复制，KeyDB也需要执行RDB保存，除非使用新的无盘复制功能。如果主机上没有磁盘使用情况，请确保启用无磁盘复制。
    * 如果您正在使用复制，请确保您的主服务器启用了持久性，或者不会在崩溃时自动重新启动：副本将尝试成为主服务器的精确副本，因此，如果主服务器使用空数据集重新启动，副本也将被擦除。
    * 默认情况下，KeyDB不需要任何身份验证，并侦听所有网络接口。如果KeyDB暴露在internet或其他攻击者可以访问的地方，这是一个很大的安全问题。
    * LATENCY DOCTOR and MEMORY DOCTOR 是你的朋友。
        
### 在EC2上运行KeyDB

* 使用基于HVM的实例，而不是基于PV的实例。
* 不要使用旧实例系列，例如：将m3.medium与HVM一起使用，而不是m1.medium与PV一起使用。
* 对**EC2 EBS卷**使用KeyDB持久性需要小心处理，因为有时EBS卷具有高延迟特性。
* 如果副本与主副本同步时出现问题，则可能需要尝试新的**无磁盘复制**。

### 备份到AWS S3

将此行添加到配置文件：db-s3-object /path/to/bucket

如果您希望KeyDB直接转储和加载到AWS S3，那么这个选项指定bucket。
将此选项与传统RDB选项一起使用将导致KeyDB向两个位置备份两次。
如果两者都被指定，KeyDB将首先尝试从本地转储文件加载，如果从S3加载失败。这需要安装和配置AWS CLI工具，这些工具在引擎盖下用于传输数据。

### 在不停机的情况下升级或重新启动KeyDB实例

KeyDB被设计成在服务器中运行很长时间的进程。例如，可以使用CONFIG SET命令修改许多配置选项，而无需重新启动。

从KeyDB 2.2开始，甚至可以在不重新启动KeyDB的情况下从AOF切换到RDB快照持久性或其他方式。
有关详细信息，请检查CONFIG GET * 命令的输出。

但是，有时必须重新启动，例如为了将KeyDB进程升级到新版本，或者需要修改CONFIG命令当前不支持的某些配置参数。

以下步骤提供了一种非常常用的方法，以避免任何停机时间。

    * 将新的KeyDB实例设置为当前KeyDB实例的从机。为了做到这一点，您需要一个不同的服务器，或者一个有足够的RAM来保持KeyDB的两个实例同时运行的服务器。
    * 如果使用单个服务器，请确保从服务器在主实例之外的其他端口启动，否则从服务器根本无法启动。
    * 等待复制初始同步完成（检查从属日志文件）。
    * 确保使用INFO时，主设备和从设备中的key数量相同。使用KeyDB-cli检查从机是否按您的意愿工作并正在回复您的命令。
    * 允许使用**CONFIG SET slave-read-only no**对从机进行写入
    * 配置所有客户机以使用新实例（即从机）。请注意，您可能需要使用CLIENT PAUSE命令，以确保在切换期间没有任何客户端可以向旧主机写入数据。
    * 一旦确定主服务器不再接收任何查询（您可以使用MONITOR命令进行检查），使用**SLAVEOF NO ONE**命令选择从服务器到主服务器，并关闭主服务器。
