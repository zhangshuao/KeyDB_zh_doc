# 延迟监视工具

KeyDB通常用于要求苛刻的用例环境中，在这种情况下，它为每个实例每秒提供大量查询，同时，对于平均响应时间和最坏情况下的延迟都有非常严格的延迟要求。

虽然KeyDB是内存系统，但它以不同的方式处理操作系统，例如，在持久化到磁盘的上下文中。此外，KeyDB实现了一组丰富的命令。某些命令是快速的，并且以恒定或对数时间运行，其他命令是较慢的O（N）命令，这可能会导致延迟峰值。

由于所有这些原因，KeyDB 2.8.13引入了一个称为延迟监控的新功能，它可以帮助用户检查和解决可能的延迟问题。延迟监视由以下概念部分组成：

* 对不同延迟敏感代码路径进行采样的延迟挂钩。
* 由不同事件分割的延迟峰值的时间序列记录。
* 从时间序列中获取原始数据的报告引擎。
* 分析引擎根据测量结果提供可读的报告和提示。

本文档的其余部分将介绍延迟监视子系统的详细信息，但是有关KeyDB和延迟的一般主题的更多信息，请阅读本文档中的KeyDB延迟问题疑难解答页面。

## 事件与时间序列

不同的监视代码路径有不同的名称，称为事件。例如，command是一个事件，用于测量可能执行慢速命令的延迟峰值，而fast command是用于监视O（1）和O（log N）命令的事件名。
其他事件不太常见，监视KeyDB执行的非常特定的操作。例如，fork事件只监视KeyDB执行fork（2）系统调用所用的时间。

延迟峰值是运行时间超过配置的延迟阈值的事件。每个被监视的事件都有一个独立的时间序列。时间序列就是这样工作的：

* 每次发生延迟峰值时，它都会记录在相应的时间序列中。
* 每个时间序列由160个元素组成。
* 每个元素都是一对：测量延迟峰值的时间的unix时间戳，以及执行事件所用的毫秒数。
* 相同的事件发生在相同的第二秒的延迟尖峰被合并（通过采取最大延迟），因此即使对于给定事件测量连续的延迟尖峰，例如因为用户设置了非常低的阈值，至少有180秒的历史可用。
* 对于每一个元素，记录所有的最大等待时间。

## 如何启用延迟监视

对于一个用例来说，高延迟是什么，对于另一个用例来说，不是高延迟。有些应用程序必须在不到1毫秒的时间内提供所有查询，而有些应用程序有时会有一小部分客户端遇到2秒的延迟，这是可以接受的。

因此，启用延迟监视器的第一步是以毫秒为单位设置延迟阈值。只有需要超过指定阈值的事件才会记录为延迟峰值。用户应根据需要设置阈值。
例如，如果对于基于KEYDB的应用程序的要求，最大可接受的等待时间是100毫秒，则应该将阈值设置为这样的值，以便记录所有服务器阻断时间等于或大于100毫秒的所有事件。

使用以下命令，可以在生产服务器的运行时轻松启用延迟监视器：

    CONFIG SET latency-monitor-threshold 100

默认情况下，禁用监视（阈值设置为0），即使延迟监视的实际成本接近于零。
然而，虽然延迟监视的内存需求非常小，但是没有充分的理由提高运行良好的KeyDB实例的基线内存使用率。

## 使用延迟命令报告信息

延迟监视子系统的用户界面是延迟命令。与许多其他KeyDB命令一样，延迟接受修改命令行为的子命令。下一节记录每个子命令

## LATENCY LATEST

LATENCY LATEST命令报告记录的最新延迟事件。每个事件都有以下字段：
    
* 事件名称。
* 事件的最新延迟峰值的Unix时间戳。
* 最新事件延迟（毫秒）。
* 此事件的所有时间最大延迟。

所有的时间并不真正意味着自从KEYDB实例启动以来的最大延迟，因为有可能使用延迟重置来重置事件数据，如我们稍后将看到的。
    
以下是输出示例：

    127.0.0.1:6379> debug sleep 1
    OK
    (1.00s)
    127.0.0.1:6379> debug sleep .25
    OK
    127.0.0.1:6379> latency latest
    1) 1) "command"
       2) (integer) 1405067976
       3) (integer) 251
       4) (integer) 1001

## LATENCY HISTORY event-name

为了从事件时间序列中获取原始数据（作为时间戳延迟对），LATENCY HISTORY命令非常有用。
对于给定的事件，该命令将返回多达160个元素。应用程序可能希望获取原始数据以执行监视、显示图形等。

示例输出：

    127.0.0.1:6379> latency history command
    1) 1) (integer) 1405067822
       2) (integer) 251
    2) 1) (integer) 1405067941
       2) (integer) 1001
   
## LATENCY RESET [event-name ... event-name]

    如果没有参数调用，则延迟重置命令重置所有事件，丢弃当前记录的延迟尖峰事件，并重置最大事件时间寄存器。
    
    通过提供事件名称作为参数，可以仅重置特定事件。该命令返回在命令执行期间重置的事件时间序列数。

## LATENCY GRAPH event-name

为指定事件生成ASCII艺术样式图：
    
    127.0.0.1:6379> latency reset command
    (integer) 0
    127.0.0.1:6379> debug sleep .1
    OK
    127.0.0.1:6379> debug sleep .2
    OK
    127.0.0.1:6379> debug sleep .3
    OK
    127.0.0.1:6379> debug sleep .5
    OK
    127.0.0.1:6379> debug sleep .4
    OK
    127.0.0.1:6379> latency graph command
    command - high 500 ms, low 101 ms (all time high 500 ms)
    --------------------------------------------------------------------------------
       #_
      _||
     _|||
    _||||
    
    11186
    542ss
    sss

每个图表列下的垂直标签表示事件发生前的秒、分、小时或天的数量。例如，"15s"表示第一个图形化事件发生在15秒之前。

该图在极小最大尺度上进行归一化，使得零（在下一行中的下划线）是最小值，而高行中的一个最大值是最大值。

graph子命令对于快速了解给定延迟事件的趋势非常有用，无需使用其他工具，也无需解释延迟历史记录提供的原始数据。

## LATENCY DOCTOR

LATENCY DOCTOR命令是延迟监视中最强大的分析工具，能够提供额外的统计数据，如延迟峰值之间的平均周期、中值偏差和对事件的可读性分析。
对于某些事件（如fork），将提供附加信息，如系统fork处理的速率。

如果您正在寻求有关延迟相关问题的帮助，则应将此输出发布在KeyDB邮件列表中。

示例输出：

    127.0.0.1:6379> latency doctor
    
    Dave, I have observed latency spikes in this KeyDB instance.
    You don't mind talking about it, do you Dave?
    
    1. command: 5 latency spikes (average 300ms, mean deviation 120ms,
       period 73.40 sec). Worst all time event 500ms.
    
    I have a few advices for you:
    
    - Your current Slow Log configuration only logs events that are
      slower than your configured latency monitor threshold. Please
      use 'CONFIG SET slowlog-log-slower-than 1000'.
    - Check your Slow Log to understand what are the commands you are
      running which are too slow to execute. Please check
      http://KeyDB.io/commands/slowlog for more information.
    - Deleting, expiring or evicting (because of maxmemory policy)
      large objects is a blocking operation. If you have very large
      objects that are often deleted, expired, or evicted, try to
      fragment those objects into multiple smaller objects.
    
医生有不稳定的心理行为，所以我们建议仔细与之互动。
