# 信号处理

本文档提供有关KeyDB如何对不同POSIX信号（如SIGTERM、SIGSEGV等）的接收作出反应的信息。

本文档中包含的信息**仅适用于KeyDB 2.6版或更高版本**。

SIGTERM信号告诉KeyDB正常关闭。当接收到该信号时，服务器实际上不会退出，但它调度关机非常类似于当关闭命令被调用时执行的Shutdown。
计划的Shutdown将尽快开始，特别是只要当前正在执行的命令终止（如果有），可能会有0.1秒或更少的额外延迟。

如果服务器被占用太多时间的Lua脚本阻塞，如果脚本可以使用script KILL终止脚本，则计划的Shutdown将在脚本终止后立即执行，或者如果自动终止。

在此情况下执行的Shutdown包括以下操作：

* 如果有后台子项正在保存RDB文件或执行AOF重写，则会杀死该子项。
* 如果AOF处于活动状态，KeyDB将调用AOF文件描述符上的fsync系统调用，以刷新磁盘上的缓冲区。
* 如果KeyDB配置为使用RDB文件在磁盘上持久，则执行同步（阻塞）保存。由于保存是以同步方式执行的，因此不使用额外的内存。
* 如果服务器已被守护，则将删除pid文件。
* 如果启用了Unix域套接字，则会将其删除。
* 服务器退出时退出代码为零。

## SIGSEGV、SIGBUS、SIGFPE和SIGILL的作用

以下信号作为KeyDB崩溃处理：

    * SIGSEGV
    * SIGBUS
    * SIGFPE
    * SIGILL

一旦这些信号中的一个被捕获，KeyDB将中止任何当前操作并执行以下操作：
    
* 在日志文件上生成错误报告。这包括堆栈跟踪、寄存器转储和有关客户端状态的信息。
* 由于KeyDB 2.8的一个快速内存测试是作为第一次检查崩溃系统的可靠性。
* 如果服务器已被守护，则将删除pid文件。
* 最后，服务器为接收到的信号注销自己的信号处理程序，并再次向自身发送相同的信号，
  以确保执行默认操作，例如在文件系统上转储内核。

## 当子进程被终止时会发生什么

当执行仅追加文件重写的子级被信号杀死时，KeyDB将此作为错误处理，
并丢弃（可能是部分或损坏的）AOF文件。稍后将重新触发重写。

当执行RDB保存的子项被终止时，KeyDB将把该情况作为一个更严重的错误处理，
因为虽然缺少aof文件重写的影响是AOF文件的扩展，但是失败的RDB文件创建的影响是缺乏持久性的。

由于生成RDB文件的孩子被信号杀死，或者当孩子以错误（非零退出代码）退出时，KeyDB进入一个特殊的错误状态，
在那里没有进一步的写入命令被接受。

    * KeyDB将继续回复读取命令。
    * KeyDB将回复所有带有错误配置错误的写命令。

此错误条件只有在成功创建RDB文件时才被清除。

## 在不触发错误条件的情况下终止RDB文件

但是，有时用户可能希望在不生成错误的情况下终止RDB保存子项。
由于KeyDB 2.6.10版本可以使用特殊方式处理的特殊信号SIGUSR1来完成：
它像任何其他信号一样杀死子进程，但父进程不会将此检测为严重错误，并将一如既往地继续服务于写请求。


