# 发布和订阅

SUBSCRIBE、UNSUBSCRIBE和PUBLISH实现了PUBLISH/SUBSCRIBE消息传递范式，其中（引用Wikipedia）发送者（发布者）未编程为将其消息发送到特定接收者（订阅者）。
相反，发布的消息被描述成channels，而不知道可能有什么（如果有的话）订阅者。
订阅者表示对一个或多个channels感兴趣，并且只接收感兴趣的消息，而不知道有什么（如果有的话）发布者。
发布者和订阅者的这种分离允许更大的可伸缩性和更动态的网络拓扑。

例如，为了订阅channels foo和bar，client发出一个提供channels名称的订阅：

    SUBSCRIBE foo bar

其他clients发送到这些通道的消息将由KeyDB推送到所有已订阅的clients。

订阅一个或多个channels的clients不应发出命令，尽管它可以订阅和取消订阅其他channels。
对订阅和取消订阅操作的回复以消息的形式发送，这样clients就可以读取一致的消息流，其中第一个元素指示消息类型。
在已订阅client的上下文中允许的命令有SUBSCRIBE、PSUBSCRIBE、UNSUBSCRIBE、PUNSUBSCRIBE、PING和QUIT。

请注意，keydb-cli在订阅模式下不会接受任何命令，只能使用Ctrl-C退出该模式。

## 推送消息的格式

消息是包含三个元素的@array应答。

第一个元素是消息的类型：

subscribe：表示我们成功地订阅了作为回复中第二个元素给出的频道。
第三个参数表示当前订阅的频道数。

unsubscribe：表示我们成功地从回复中作为第二个元素给出的频道中取消订阅。
第三个参数表示当前订阅的频道数。当最后一个参数为0时，我们不再订阅任何通道，客户端可以发出任何类型的KeyDB命令，
因为我们不在Pub/Sub状态。

message：它是由另一个客户端发出的发布命令接收的消息。
第二个元素是原始通道的名称，第三个参数是实际的消息负载。

## 数据库和作用域

Pub/Sub 与key空间无关。它是为了在任何级别上都不干扰它，包括数据库号。

在db10上发布，将由db1上的订阅到。

如果需要某种作用域，请在通道前面加上环境名称（测试、临时工作台、生产等）。

## 有线协议示例

    SUBSCRIBE first second
    *3
    $9
    subscribe
    $5
    first
    :1
    *3
    $9
    subscribe
    $6
    second
    :2

此时，我们从另一个client对名为second的通道发出发布操作：

    > PUBLISH second Hello

这是第一个client收到的：

    *3
    $7
    message
    $6
    second
    $5
    Hello

现在，client使用UNSUBSCRIBE命令从所有通道中取消订阅，而不使用其他参数：

    UNSUBSCRIBE
    *3
    $11
    unsubscribe
    $6
    second
    :1
    *3
    $11
    unsubscribe
    $5
    first
    :0


## 模式-匹配订阅

KeyDB Pub/Sub实现支持模式匹配。client可以订阅glob-style的模式，以便接收发送到与给定模式匹配的频道名称的所有消息。
例如：

    PSUBSCRIBE news.*

将接收发送到频道news.art.figurative、news.music.jazz等的所有消息。
所有glob-style的模式都有效，因此支持多个通配符。

    PUNSUBSCRIBE news.*

然后将从该模式中取消订阅client。此呼叫不会影响其他订阅。

由于模式匹配而接收到的消息将以不同的格式发送：

* 消息的类型是pmessage：它是由另一个client发出的与模式匹配的订阅匹配的发布命令接收的消息。
第二个元素是匹配的原始模式，第三个元素是原始通道的名称，最后一个元素是实际的消息负载。

与SUBSCRIBE和UNSUBSCRIBE类似，PSUBSCRIBE和PUNSUBSCRIBE命令
由系统使用与SUBSCRIBE和UNSUBSCRIBE消息格式相同的格式发送PSUBSCRIBE和PUNSUBSCRIBE类型的消息来确认。


## 同时匹配模式和通道订阅的消息

如果client订阅了与已发布消息匹配的多个模式，或者同时订阅了与消息匹配的模式和通道，则client可能多次接收单个消息。
如下例所示：

    SUBSCRIBE foo
    PSUBSCRIBE f*

在上面的例子中，如果一条消息被发送到channel foo，client将收到两条消息：一条消息类型为message，另一条消息类型为pmessage。

## 模式匹配下订阅计数的意义

在subscribe、unsubscribe、psubscribe和punsubscribe消息类型中，最后一个参数是仍处于活动状态的订阅数。
这个数字实际上是client仍然订阅的频道和模式的总数。
因此，只有当所有的频道和模式不订阅时，client才会退出PUB/SUB状态。

## 编程示例

Pieter Noordhuis提供了一个使用EventMachine和KeyDB创建多用户高性能web聊天的好例子。

## 客户端库实现提示

因为接收到的所有消息都包含导致消息传递的原始订阅（消息类型为channel通道，pmessage类型为原始模式），
所以客户端库可以使用哈希表将原始订阅绑定到回调（可以是匿名函数、块、函数指针）。

当收到消息时，可以执行O(1)查找，以便将消息传递到已注册的回调。
