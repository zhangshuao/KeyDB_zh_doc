# 手动设置群集

## 使用KeyDB设置集群

请记住，由于版本不同，我们不需要使用keydb-trib.rb，因为现在keydb-cli有了--cluster create选项。

我们将从一个与create-cluster util类似的示例开始。允许创建一个包含3个主节点和3个副本的6节点设置。

执行以下操作6次，每个节点一次。可以为每个文件创建单独的keydb.conf文件，也可以在启动时附加配置文件。

## 生成配置文件和位置

要么做manually手动，要么通过下面的脚本。对端口30000-30005（带有端口#）手动执行以下操作：

    mkdir <port>
    cd <port> 
    nano keydb.conf
        port <port>
        cluster-enabled yes
        cluster-config-file nodes.conf
        cluster-node-timeout 5000
        appendonly yes
        
        dir ./
        loglevel notice
        logfile <port>.log
    
        save 900 1
        save 300 10
        save 60 10000

如果不想手动执行，请编写脚本：

    #!/usr/bin/env bash
    # myscript.sh
    
    for port in 7000 7001 7002 7003 7004 7005
    do
      mkdir ${port}
      cd ${port}
      cat >keydb.conf << EOF
    port ${port}
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    appendonly yes
    dir ./
    loglevel notice
    logfile ${port}.log
    save 900 1
    save 300 10
    save 60 10000
    EOF
      cd ..
    done

注意，如果您连接到不同的机器，您需要在keydb.conf *中指定绑定地址，这是一个最小的配置，可能还需要设置身份验证等。

## 运行实例和创建集群

现在启动keydb服务器实例，为每个端口实例加载配置文件 keydb-server /path-to-dir-above/keydb.conf

接下来使用以下命令创建集群：

    keydb-cli --cluster create 127.0.0.1:30000 127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 --cluster-replicas 1

x连接keydb-cli后，可以运行CLUSTER INFO和CLUSTER NODES来获取集群上的相应信息。

## 测试群集设置

以群集模式（-c）将keydb cli连接到端口30000，然后尝试以下操作：

    $ redis-cli -c -p 30000
    keydb 127.0.0.1:30000> set foo bar
    -> Redirected to slot [12182] located at 127.0.0.1:30002
    OK
    keydb 127.0.0.1:30002> set hello world
    -> Redirected to slot [866] located at 127.0.0.1:30000
    OK
    keydb 127.0.0.1:30000> get foo
    -> Redirected to slot [12182] located at 127.0.0.1:30002
    "bar"
    keydb 127.0.0.1:30000> get hello
    -> Redirected to slot [866] located at 127.0.0.1:30000
    "world"

## 其他一些命令

将节点添加到现有集群中。

    keydb-cli --cluster add-node 127.0.0.1:30006 127.0.0.1:30000

注意，我们使用指定新节点的地址作为第一个参数的add-node命令，并将群集中随机存在的节点的地址作为第二个参数来关联。

将副本添加到比其他副本少的主副本，或随机添加：

    keydb-cli --cluster add-node 127.0.0.1:30006 127.0.0.1:30000 --cluster-slave

将副本添加到特定主机：

    keydb-cli --cluster add-node 127.0.0.1:30006 127.0.0.1:30000 --cluster-slave --cluster-master-id 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e

或者通过连接到新节点来复制特定的主节点，并且：

    cluster replicate 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e
    
reshard:

    keydb-cli reshard <host>:<port> --cluster-from <node-id> --cluster-to <node-id> --cluster-slots <number of slots> --cluster-yes

