# 活动复制设置

## 设置副本节点以轻松接受 读 & 写

KeyDB现在支持活动副本（也称为"活动-活动"）。这大大简化了故障转移场景，因为不再需要将副本提升到活动主节点。
此外，"活动副本"支持可用于在高写入情况下分配负载。

## 工作原理

默认情况下，KeyDB的作用与Redis相同，只允许从主服务器到副本的单向通信。添加了一个新的配置选项"active-replica"，
当设置为true时还意味着"replica-read-only no"。在此模式下，即使KeyDB与主服务器的连接断开，KeyDB也将接受副本。它还允许两个节点相互控制的循环连接。

## 脑裂

KeyDB可以处理脑裂场景，在这些场景中，主服务器之间的连接被切断，但仍在继续进行写操作。
每次写入都有时间戳，当连接恢复时，每个主机都将共享它们的新数据。最新的写入将获胜。这可防止陈旧数据覆盖断开连接后写入的新数据。

## 启用步骤
 
以下步骤假设有两个服务器，A和B。

1.两台服务器在各自的配置文件中都必须有"active-replica yes"
2.在服务器B上执行命令"replicaof [A address] [A port]" 服务器B将删除其数据库并加载服务器A的数据集
3.在服务器A上执行命令"replicaof [B address] [ port]" 服务器A将删除其数据库并加载服务器B的数据集（包括在上一步中刚刚传输的数据）
4.两台服务器现在都将向彼此传播写操作。可以通过写入服务器A上的key并确保它在B上可见（反之亦然）来对此进行测试。

在YouTube上观看我们的演示：

    https://www.youtube.com/embed/2QOICUsBEls?start=12

## 技术实现

启动时，每个KeyDB实例将计算一个动态UUID。这个UUID没有保存，只存在于进程的生命周期中。当复制副本连接到其主服务器时，它将通知主服务器其UUID，主服务器将用自己的UUID进行回复。
如果两个客户机来自同一个KeyDB实例（IPs和端口不足，因为同一台计算机上可能有不同的进程），则比较uuid以通知服务器。uuid用于防止对发送它们的主机（如果它也是我们的副本）进行重新广播更改。

将添加一个新的配置选项以启用此模式，并且在启用时，即使KeyDB是副本，也会使其可写（默认情况下，这是禁用的）。
除了防止循环中客户端之间无限跳转查询的额外逻辑外，复制代码将按正常方式执行。

此更改中实现了大多数活动复制

## 设置活动复制

活动复制节点允许您对两个实例进行读写操作，这两个实例在高负载下可以增加读操作，并使backup/replica节点准备好进入故障场景。
安装程序与设置代理服务器以指向正常实例一样简单。请看HAProxy部分，例如可以启用运行状况检查的配置，以及设置代理服务器的不同路由配置（round-robin, first, 等）非常简单，
keydb配置甚至比前面描述的更简单。配置文件示例：

## 配置文件

实例-A 配置文件:

    # assuming below parameters were set and IP address of this instance is 10.0.0.2
    port 6379
    requirepass mypassword123
    masterauth mypassword123
    # you will need to configure the following
    active-replica yes
    replicaof 10.0.0.3 6379

实例-B 配置文件:

    # assuming below parameters were set and IP address of this instance is 10.0.0.3
    port 6379
    requirepass mypassword123
    masterauth mypassword123
    # you will need to configure the following
    active-replica yes
    replicaof 10.0.0.2 6379

您还可以附加到配置文件keydb-server --active-replica yes --replica of <ipaddress> <port>

## 测试活动-复制

写入一个节点的任何命令都将显示在另一个节点上。如果服务器停机，则时间戳将确保副本在重新联机时不会覆盖较新的写入。
这使您能够设置脚本、cron等，以便在需要时自动重新启动失败的实例，而不会有覆盖新数据的风险。
在极高的负载下，可能有轻微的延迟，但在数据同步方面仍然很低（几乎可以忽略不计）。

